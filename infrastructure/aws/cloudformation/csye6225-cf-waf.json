{  
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"AWS Web Applicaton Firewall CloudFormation Template",
   "Resources":{  
      "ourWebACLAssociation":{  
         "Type":"AWS::WAFRegional::WebACLAssociation",
         "Properties":{  
            "ResourceArn":{  
               "Fn::ImportValue":"ourLoadBalancer"
            },
            "WebACLId":{  
               "Ref":"ourWebACL"
            }
         }
      },
      "ourRule":{  
         "Type":"AWS::WAFRegional::Rule",
         "Properties":{  
            "Name":"ourIPSetRule",
            "MetricName":"ourIPSetRule",
            "Predicates":[  
               {  
                  "DataId":{  
                     "Ref":"ourIPSetBlacklist"
                  },
                  "Negated":false,
                  "Type":"IPMatch"
               }
            ]
         }
      },
      "ourIPSetBlacklist":{  
         "Type":"AWS::WAFRegional::IPSet",
         "Properties":{  
            "Name":"IPSet for blacklisted IP addresses",
            "IPSetDescriptors":[  
               {  
                  "Type":"IPV4",
                  "Value":"10.0.0.68/32"
               },
               {  
                  "Type":"IPV4",
                  "Value":"192.168.202.135/32"
               }
            ]
         }
      },
      "ourWebACL":{  
         "Type":"AWS::WAFRegional::WebACL",
         "Properties":{  
            "Name":"The WebACL rules",
            "DefaultAction":{  
               "Type":"ALLOW"
            },
            "MetricName":"ourWebACL",
            "Rules":[  
               {  
                  "Action":{  
                     "Type":"BLOCK"
                  },
                  "Priority":1,
                  "RuleId":{  
                     "Ref":"ourRule"
                  }
               },
               {  
                  "Action":{  
                     "Type":"BLOCK"
                  },
                  "Priority":2,
                  "RuleId":{  
                     "Ref":"XSSRule"
                  }
               },
               {  
                  "Action":{  
                     "Type":"BLOCK"
                  },
                  "Priority":3,
                  "RuleId":{  
                     "Ref":"SqlInjRule"
                  }
               }
            ]
         }
      },
      "SqlInjRule":{  
         "Type":"AWS::WAFRegional::Rule",
         "Properties":{  
            "Name":"SqlInjRule",
            "MetricName":"SqlInjRule",
            "Predicates":[  
               {  
                  "DataId":{  
                     "Ref":"SqlInjDetection"
                  },
                  "Negated":false,
                  "Type":"SqlInjectionMatch"
               }
            ]
         }
      },
      "SqlInjDetection":{  
         "Type":"AWS::WAFRegional::SqlInjectionMatchSet",
         "Properties":{  
            "Name":"Find SQL injections in the query string",
            "SqlInjectionMatchTuples":[  
               {  
                  "FieldToMatch":{  
                     "Type":"QUERY_STRING"
                  },
                  "TextTransformation":"URL_DECODE"
               },
               {  
                  "FieldToMatch":{  
                     "Type":"BODY"
                  },
                  "TextTransformation":"URL_DECODE"
               }
            ]
         }
      },
      "XSSRule":{  
         "Type":"AWS::WAFRegional::Rule",
         "Properties":{  
            "Name":"XSSRule",
            "MetricName":"XSSRule",
            "Predicates":[  
               {  
                  "DataId":{  
                     "Ref":"DetectXSS"
                  },
                  "Negated":false,
                  "Type":"XssMatch"
               }
            ]
         }
      },
      "DetectXSS":{  
         "Type":"AWS::WAFRegional::XssMatchSet",
         "Properties":{  
            "Name":"XssMatchSet",
            "XssMatchTuples":[  
               {  
                  "FieldToMatch":{  
                     "Type":"QUERY_STRING"
                  },
                  "TextTransformation":"URL_DECODE"
               },
               {  
                  "FieldToMatch":{  
                     "Type":"BODY"
                  },
                  "TextTransformation":"URL_DECODE"
               }
            ]
         }
      }
   }
}